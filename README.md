# rabbitmq-parent
spring boot集成rabbitmq

一、RabbitMq如何保证消息不丢失？
    MQ如何保证消息不丢失：持久化机制
    
    1、生产者角色：
    确保生产者投递消息到mq服务器成功。
      ACK消息确认机制
      同步或者异步（开启一个监听，异步回调） 
      方式1：Confirms
      方式2：事务消息
      
    2、消费者角色：
    rabbitmq:
      必须将消息消费成功后，再将消息从mq服务器中移除;
    kafka:
      在Kafka中有所不同，无论消费者消费成功或失败，服务器中的消息都不会在短时间内被移除; offset:偏移量 定时任务清除掉
      
    3、mq服务端
      在默认情况下，都会对队列中的消息实现持久化，持久化到硬盘
  
  
二、rabbitmq角色：

    1、Virtual Hosts :区分不同的团队
    
    2、交换机的种类：路由消息存放在那个队列中
    
    3、队列:存放消息
    
    4、路由key：分发规则
    
    
    直连交换机（Direct exchange）：
    
    扇形交换机（Fanout exchange）：
      1、需要创建两个队列，每个队列对应一个消费者；
      2、队列需要绑定交换机；
      3、生产者投递消息到交换机，交换机将消息分配给两个队列中存放起来；
      4、消费者从队列中获取这个消息；
    主题交换机（Topic exchange）
    头交换机（Headers exchange）
    
    
三、生产者如何获取消息的消费情况

    1、根据业务来定
    投递消息之前生成一个全局ID  消息在消费成功后入库  然后查询
    
    
    2、RocketMq 自带  生产者投递消息时会返回一个全局的消息ID  定时每隔2秒根据全局消息ID获取
    
    
四、死信队列的架构原理

    死信队列和普通的队列区别不是很大
    普通队列和死信队列都有自己独立的交换机和路由key、队列和消费者；
    
    区别：
    1、生产者投递消息先将消息投递到普通的交换机中，普通的交换机将消息缓存在普通的队列中，普通的队列对应着自己的消费者；
    2、如果投递到普通队列的消息一直没有被消息者消费，会将该消息转移到死信（备胎）交换机中，死信交换机也会对应着自己的死信队列、路由key和消费者。
    
    例：30分钟订单超时设计
    1、redis过期key
    
    2、死信队列实现
    采用死信队列，创建一个普通队列，在30分钟内无消费者进行消费，就会将消息转移到死信队列中去
    死信队列的消费者会消费对应死信队列中的消息，根据订单ID查询是否已经支付过，如果没有支付会进行回滚库存操作。
    
    
五、RabbitMq的消息幂等性问题

    rabbitmq消息自动重试机制
    1、当消费者在执行业务代码的过程中，如果抛出异常的情况下，在这个时候会自动触发重试机制。  在默认的情况下rabbitmq会无限次数进行重试
    mq在进行重试的过程中，有可能会引发消费者重复消费的问题，这时会产生数据幂等性的问题



六、广播交换机（ExchangeTypeEnum.fanout）的使用场景有哪些

    ​ 广播交换机的角色类似于村里面的小喇叭，当有新的政策传达给这个村时，就会使用小喇叭播放，这样每个人（队列）都停到了内容。
    ​ 可用于发送类似公告、系统全局通知等广播需求。

七、直连交换机（ExchangeTypeEnum.direct）的使用场景有哪些

    ​ 直连交换机的角色类似于邮递员，信封上写明了收件地址，收到的消息会根据目的地的不同投入到不同的队列中，若是邮递员没有找到这个地址，这封信就被丢弃了。
    ​ 可用于点对点之间的通讯。

八、通配符交换机（ExchangeTypeEnum.topic）的使用场景有哪些

    ​ 通配符交换机类似于脑子不聪明的邮件分发员，收到有一封送往“张家镇李家村12号”的信件，分发员来到分发点，发现有两个有污渍的邮箱（队列），一个能看清\*李家村\*，一个能看清张家镇\*，快递员干脆就将信件复制了一份，往两个地方都送了投递了一份。
    ​ 可用于同一个任务，需要不同模块或者分布式系统的模块同时执行时使用。

九、头交换机（ExchangeTypeEnum.headers）的使用场景有哪些
    
    头交换机类似于程序中的鉴权，管理员拥有全部权限，用户拥有查看权限，用户无法调用需要管理员权限的接口（消息无法分发到未监听该header的队列），拥有相应权限才能调用相应权限的接口（消息分发到监听该header的队列）。
    这里需要注意，头交换机支持完全匹配和部分匹配，完全匹配为管理员接口必须拥有所有管理员权限才可调用，即拥有所有管理员权限才显示进入管理员后台的按钮。部分匹配为拥有其中一个或部分权限即可调用，即拥有任意管理员权限就显示进入管理员后台的按钮。